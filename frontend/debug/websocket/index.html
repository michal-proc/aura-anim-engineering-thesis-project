<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Job Status WebSocket Viewer</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 700px;
        margin: 40px auto;
        padding: 0 16px;
        background: #f5f5f5;
      }

      .card {
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }

      #log {
        background: #111;
        color: #ddd;
        padding: 10px;
        height: 250px;
        overflow-y: auto;
        white-space: pre-wrap;
        border-radius: 6px;
        font-family: monospace;
      }

      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      #connectBtn {
        background: #2563eb;
        color: white;
      }

      #disconnectBtn {
        background: #dc2626;
        color: white;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Realtime Job Status</h1>

    <div class="card">
      <label>Job ID:</label>
      <input
        id="jobId"
        placeholder="Enter job UUID"
        style="width: 100%; padding: 8px"
      />

      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div class="card">
      <div>Job ID: <span id="currentJobId">–</span></div>
      <div>Name: <span id="jobName">–</span></div>
      <div>Status: <span id="jobStatus">–</span></div>
      <div>Final: <span id="jobFinal">–</span></div>
      <div>Last update: <span id="jobTimestamp">–</span></div>

      <label>Progress:</label>
      <progress id="jobProgress" value="0" max="100"></progress>
      <span id="jobProgressLabel">0%</span>
    </div>

    <div class="card">
      <h3>Log</h3>
      <div id="log"></div>
    </div>

    <script>
      let socket = null;

      const logEl = document.getElementById("log");

      function log(msg) {
        logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setConnectedUI(state) {
        document.getElementById("connectBtn").disabled = state;
        document.getElementById("disconnectBtn").disabled = !state;
        document.getElementById("jobId").disabled = state;
      }

      document.getElementById("connectBtn").onclick = () => {
        const jobId = document.getElementById("jobId").value.trim();
        if (!jobId) return alert("Job ID is required");

        // Hardcoded WebSocket URL (works from file://)
        const url = `ws://directable-connie-addedly.ngrok-free.dev/videos/jobs/${jobId}/ws`;

        log(`Connecting to ${url} ...`);
        socket = new WebSocket(url);

        socket.onopen = () => {
          log("Connected.");
          setConnectedUI(true);
          document.getElementById("currentJobId").textContent = jobId;
        };

        socket.onmessage = (event) => {
          log(`Incoming: ${event.data}`);
          try {
            const data = JSON.parse(event.data);

            if (data.error) {
              document.getElementById("jobStatus").textContent = "ERROR";
              return;
            }

            document.getElementById("jobName").textContent = data.name || "–";
            document.getElementById("jobStatus").textContent =
              data.status || "–";
            document.getElementById("jobFinal").textContent = data.final
              ? "yes"
              : "no";
            document.getElementById("jobTimestamp").textContent =
              data.timestamp || new Date().toLocaleString();

            if (typeof data.progress_percentage === "number") {
              document.getElementById("jobProgress").value =
                data.progress_percentage;
              document.getElementById("jobProgressLabel").textContent =
                data.progress_percentage + "%";
            }
          } catch (err) {
            log("JSON parse error: " + err);
          }
        };

        socket.onerror = (e) => {
          log("WebSocket error (see console).");
        };

        socket.onclose = () => {
          log("Connection closed.");
          setConnectedUI(false);
        };
      };

      document.getElementById("disconnectBtn").onclick = () => {
        if (socket) socket.close();
      };
    </script>
  </body>
</html>
